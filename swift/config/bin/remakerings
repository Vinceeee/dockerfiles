#!/bin/bash

#set -e

POWER=6
DEVICES_CNT=2
devices="sdb sdc"
builders="account.builder container.builder object.builder"

mkdir -p /srv/node
chown -R swift:swift /srv/node

cd /etc/swift
rm -f *.builder *.ring.gz backups/*.builder backups/*.ring.gz

# create swift ring builders
swift-ring-builder account.builder create 6 2 1
swift-ring-builder container.builder create 6 2 1
swift-ring-builder object.builder create 6 2 1

for dev in $devices;do
    mkdir -p /srv/node/$dev
    mount /dev/$dev /srv/node/$dev 
    swift-ring-builder account.builder add r1z1-0.0.0.0:6012/$dev 1
    swift-ring-builder container.builder add r1z1-0.0.0.0:6011/$dev 1
    swift-ring-builder object.builder add r1z1-0.0.0.0:6010/$dev 1
done

for each in $builders;
do
    swift-ring-builder $each rebalance
done

swift-init all start

echo "ring setup completed."
